generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model admins {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String   @unique
  password_hash String
  role          String   @default("host")
  display_name  String?
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  rooms         rooms[]
}

model answer_options {
  id           BigInt         @id @default(autoincrement())
  question_id  BigInt
  text         String
  is_correct   Boolean        @default(false)
  order        Int            @default(0) @db.SmallInt
  questions    questions      @relation(fields: [question_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  room_answers room_answers[]

  @@index([question_id], map: "idx_answer_options_qid")
}

model categories {
  id          BigInt      @id @default(autoincrement())
  name        String      @unique
  slug        String      @unique
  description String?
  icon_url    String?
  created_at  DateTime    @default(now()) @db.Timestamptz(6)
  questions   questions[]
}

model players {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  display_name String
  created_at   DateTime       @default(now()) @db.Timestamptz(6)
  room_answers room_answers[]
  room_players room_players[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model questions {
  id             BigInt           @id @default(autoincrement())
  category_id    BigInt?
  stem           String
  difficulty     String
  is_active      Boolean          @default(true)
  created_at     DateTime         @default(now()) @db.Timestamptz(6)
  updated_at     DateTime         @default(now()) @db.Timestamptz(6)
  answer_options answer_options[]
  categories     categories?      @relation(fields: [category_id], references: [id], onUpdate: NoAction)
  room_rounds    room_rounds[]

  @@index([is_active, difficulty], map: "idx_questions_active")
  @@index([category_id], map: "idx_questions_category")
}

model room_answers {
  id                 BigInt          @id @default(autoincrement())
  room_round_id      BigInt
  player_id          String          @db.Uuid
  selected_option_id BigInt?
  answered_at        DateTime?       @db.Timestamptz(6)
  response_time_ms   Int?
  is_correct         Boolean?
  score_awarded      Int             @default(0)
  players            players         @relation(fields: [player_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  room_rounds        room_rounds     @relation(fields: [room_round_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  answer_options     answer_options? @relation(fields: [selected_option_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([room_round_id, player_id])
  @@index([player_id], map: "idx_room_answers_player")
  @@index([room_round_id], map: "idx_room_answers_round")
}

model room_players {
  room_id     BigInt
  player_id   String    @db.Uuid
  joined_at   DateTime  @default(now()) @db.Timestamptz(6)
  left_at     DateTime? @db.Timestamptz(6)
  total_score Int       @default(0)
  players     players   @relation(fields: [player_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  rooms       rooms     @relation(fields: [room_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([room_id, player_id])
  @@index([player_id], map: "idx_room_players_player")
}

model room_rounds {
  id            BigInt         @id @default(autoincrement())
  room_id       BigInt
  question_id   BigInt
  order_in_room Int
  started_at    DateTime       @default(now()) @db.Timestamptz(6)
  time_limit_ms Int?
  room_answers  room_answers[]
  questions     questions      @relation(fields: [question_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  rooms         rooms          @relation(fields: [room_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([room_id], map: "idx_room_rounds_room")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model rooms {
  id            BigInt         @id @default(autoincrement())
  code          String?        @unique
  host_admin_id String?        @db.Uuid
  status        String         @default("lobby")
  created_at    DateTime       @default(now()) @db.Timestamptz(6)
  started_at    DateTime?      @db.Timestamptz(6)
  ended_at      DateTime?      @db.Timestamptz(6)
  room_players  room_players[]
  room_rounds   room_rounds[]
  admins        admins?        @relation(fields: [host_admin_id], references: [id], onUpdate: NoAction)

  @@index([status], map: "idx_rooms_status")
}
