// ------------------------------------------------------
// Prisma Schema for Tap Tap Trivia (PostgreSQL)
// ------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -------------------- Admins --------------------------
model Admin {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  passHash   String   @map("pass_hash")
  name       String
  rooms      Room[]
}

// --------------------- Rooms --------------------------
model Room {
  id        Int      @id @default(autoincrement())
  code      String
  adminId   Int
  admin     Admin    @relation(fields: [adminId], references: [id])
  categories RoomCategory[]
  sessions  Session[]
}

// Join table for Rooms â†” Categories (many-to-many)
model RoomCategory {
  id          Int        @id @default(autoincrement())
  roomId      Int
  categoryId  Int

  room        Room       @relation(fields: [roomId], references: [id])
  category    Category   @relation(fields: [categoryId], references: [id])

  @@unique([roomId, categoryId])
}

// -------------------- Categories ----------------------
model Category {
  id          Int        @id @default(autoincrement())
  name        String
  description String
  trivias     Trivia[]
  rooms       RoomCategory[]
}

// -------------------- Trivia --------------------------
model Trivia {
  id          Int         @id @default(autoincrement())
  name        String
  categoryId  Int

  category    Category    @relation(fields: [categoryId], references: [id])
  questions   Question[]
}

// -------------------- Questions -----------------------
model Question {
  id          Int         @id @default(autoincrement())
  actualQuestion String   @map("actual_question")
  triviaId    Int

  trivia      Trivia      @relation(fields: [triviaId], references: [id])
  options     Option[]
}

// --------------------- Options ------------------------
model Option {
  id          Int        @id @default(autoincrement())
  text        String     @map("option")
  questionId  Int

  question    Question   @relation(fields: [questionId], references: [id])
  answers     Answer[]
}

// --------------------- Answers ------------------------
model Answer {
  id        Int    @id @default(autoincrement())
  optionId  Int

  option    Option @relation(fields: [optionId], references: [id])
}

// --------------------- Sessions -----------------------
model Session {
  id         Int       @id @default(autoincrement())
  startTime  DateTime  @map("start_time")
  endTime    DateTime  @map("end_time")
  roomId     Int

  room       Room      @relation(fields: [roomId], references: [id])
  players    Player[]
}

// --------------------- Players ------------------------
model Player {
  id        Int       @id @default(autoincrement())
  username  String
  sessionId Int

  session   Session   @relation(fields: [sessionId], references: [id])
  winners   Winner[]   // <-- one-to-many, not one-to-one

  // This enforces: a user cannot join the same session under the same username twice.
  @@unique([username, sessionId])
}

// --------------------- Winner -------------------------
model Winner {
  id        Int       @id @default(autoincrement())
  score     Int
  playerId  Int

  player    Player    @relation(fields: [playerId], references: [id])
}
 
